<!DOCTYPE html>
<html lang="en">

<head>
	<title>Chat Example</title>
	<script type="text/javascript">
		window.onload = function () {
			let conn;
			let msg = document.getElementById("msg");
			console.log("menu_id", menu_id, "menu_name", menu_name, "quantity", quantity)
			let log = document.getElementById("log");

			function appendLog(item) {
				let doScroll =
					log.scrollTop > log.scrollHeight - log.clientHeight - 1;
				log.appendChild(item);
				if (doScroll) {
					log.scrollTop = log.scrollHeight - log.clientHeight;
				}
			}

			document.getElementById("form").onsubmit = function (event) {
				event.preventDefault();

				let menuId = document.getElementById("menu_id");
				let menuName = document.getElementById("menu_name");
				let quantity = document.getElementById("quantity");
				console.log("menu_id", parseInt(menuId.value), "menu_name", menuName.value, "quantity", parseInt(quantity.value))
				const id = parseInt(menuId.value);
				const name = menuName.value;
				const qtt = parseInt(quantity.value);

				let payload = {
					action: 1,
					menu: {
						menu_id: id,
						menu_name: name,
						quantity: qtt,
						order_users: [542, 23],
					},
				};
				if (!conn) {
					return false;
				}
				if (!menuId.value || !menuName.value || !quantity.value) {
					console.error("need some required fields")
					return false;
				}
				conn.send(JSON.stringify(payload));
				msg.value = "";
				return false;
			};

			if (window["WebSocket"]) {
				const params = window.location.href.split("/");
				const roomId = params[params.length - 1];
				conn = new WebSocket(
					"ws://" + document.location.host + "/ws/" + roomId
				);

				conn.onopen = function (evt) {
					console.log("log connect event", evt)
				}

				conn.onclose = function (evt) {
					let item = document.createElement("div");
					item.innerHTML = "<b>Connection closed.</b>";
					appendLog(item);
				};
				conn.onmessage = function (evt) {
					console.log("message event", evt)
					let messages = evt.data.split("\n");
					for (let i = 0; i < messages.length; i++) {
						let item = document.createElement("div");
						item.innerText = messages[i];
						appendLog(item);
					}
				};
			} else {
				let item = document.createElement("div");
				item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
				appendLog(item);
			}
		};
	</script>
	<style type="text/css">
		html {
			overflow: hidden;
		}

		body {
			overflow: hidden;
			padding: 0;
			margin: 0;
			width: 100%;
			height: 100%;
			background: gray;
		}

		#log {
			background: white;
			margin: 0;
			padding: 0.5em 0.5em 0.5em 0.5em;
			position: absolute;
			top: 0.5em;
			left: 0.5em;
			right: 0.5em;
			bottom: 3em;
			overflow: auto;
		}

		#form {
			padding: 0 0.5em 0 0.5em;
			margin: 0;
			position: absolute;
			bottom: 1em;
			left: 0px;
			width: 100%;
			overflow: hidden;
		}
	</style>
</head>

<body>
	<div id="log"></div>
	<form id="form">
		<input type="text" id="msg" size="64" />
		<input type="text" id="menu_id" size="64" autofocus />
		<input type="text" id="menu_name" size="64" />
		<input type="text" id="quantity" size="64" />
		<input type="submit" value="Send" />
	</form>
</body>

</html>
